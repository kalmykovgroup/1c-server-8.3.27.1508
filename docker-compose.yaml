services:
  pgsql:
    build:
      context: ./pgsql
      dockerfile: Dockerfile
      args:
        - CONF_DIR=${PG_CONF_DIR} # –ü—É—Ç—å –∫ –∫–∞—Ç–∞–ª–æ–≥—É –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏     
    container_name: pgsql
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${POSTGRES_USER} # –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–ª—è 1–° 
      POSTGRES_DB: ${POSTGRES_DB}                     # –ù–∞–∑–≤–∞–Ω–∏–µ –ë–î –¥–ª—è 1–°
      POSTGRES_HOST: ${POSTGRES_HOST}  
      DATA_DIR: ${DATA_DIR}  # –ü—É—Ç—å –∫ –∫–∞—Ç–∞–ª–æ–≥—É –¥–∞–Ω–Ω—ã—Ö
      PG_BIN: ${PG_BIN}  # –ü—É—Ç—å –∫ –∫–∞—Ç–∞–ª–æ–≥—É –¥–∞–Ω–Ω—ã—Ö
      SOCKET_DIR: ${SOCKET_DIR}  # –ü—É—Ç—å –∫ socket  
      LANG: ru_RU.UTF-8
      LC_ALL: ru_RU.UTF-8 
    networks:
      - internal_pgsql
      - public
    volumes:
      - pg-data-1c:${DATA_DIR}  # üëà –î–∞–Ω–Ω—ã–µ –ë–î  
      - ./secrets/pass_pgsql:/run/secrets/pass_pgsql:ro
  
  server:
    build:
      context: ./1c-server
      args:
        - ONEC_VERSION=${ONEC_VERSION}
        - ONEC_USER=${ONEC_USER}
        - ONEC_GROUP=${ONEC_GROUP}
        - LOG_DIR=${LOG_DIR}
        - BIN=${BIN}
        - DATA=${DATA}
        - CACHE=${CACHE}
        - LICENSES=${LICENSES}
        - HASP=${HASP}
        - PATH_TO_1C=${PATH_TO_1C}
        - WS_PUBLIC_DIR=${WS_PUBLIC_DIR}
        - CLUSTER_PORT_RAGENT=${CLUSTER_PORT_RAGENT}
        - APACHE_PUBLICATION_CONF_DIR=${APACHE_PUBLICATION_CONF_DIR} # /etc/apache2/sites-available 
        - ONEC_INSTALLER_NAME=${ONEC_INSTALLER_NAME} # /etc/apache2/sites-available 
      dockerfile: Dockerfile 
    container_name: server
    hostname: ${DOMAIN}  # üëà –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û
    depends_on:
      - pgsql
    environment:
      - POSTGRES_DB=${POSTGRES_DB}
      - POSTGRES_USER=${POSTGRES_USER} 
      - ONEC_VERSION=${ONEC_VERSION}   
      - ONEC_PORT_RANGE=${ONEC_PORT_RANGE}   
      - DOMAIN=${DOMAIN}
      - ./web-config:${PATH_TO_1C}
      #- HOST_IP=host.docker.internal
    ports: 
      - "1540"  # ragent (—Ç–æ–Ω–∫–∏–µ –∫–ª–∏–µ–Ω—Ç—ã)
      - "1541"  # rmngr/rphost
      - "1545"  # ras (–∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ)
      - "1555"  # ras (–º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥)  
      - "5901:5901" #VNC
      - "${ONEC_PORT_RANGE_DOCKER}" # –†–∞–±–æ—á–∏–µ –ø—Ä–æ—Ü–µ—Å—Å—ã (session)  
      - "80" # Apache –≤–Ω—É—Ç—Ä–∏ server —Ç–µ–ø–µ—Ä—å –æ—Ç–¥–∞—ë—Ç Web-–∫–ª–∏–µ–Ω—Ç
    volumes:
      - 1c-data:/var/lib/1c-server      # –û—Å–Ω–æ–≤–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∫–ª–∞—Å—Ç–µ—Ä–∞ 
      - ./1c-server/logs/:${LOG_DIR}/      # –õ–æ–≥–∏ 
      - ./1c-server/logs/apache2:${APACHE_LOG}      # –õ–æ–≥–∏ apache2
      - ./1c-server/licenses/:${LICENSES}/       
      - 1c-user-home:/home/usr1cv8/.1cv8/ 
      - ./.env:/env/.env:ro  
      - ./1c-server/web-config/publication:${APACHE_PUBLICATION_CONF_DIR} 
      - ./1c-server/web-config/vrd:/var/www/ws
      - ./secrets/pass_pgsql:/run/secrets/pass_pgsql:ro 
    networks:
       internal_pgsql:  # –î–ª—è —Å–≤—è–∑–∏ —Å PostgreSQL 
       public:    # –î–ª—è –≤–Ω–µ—à–Ω–µ–≥–æ –¥–æ—Å—Ç—É–ø–∞ (nginx, ping, telnet)
         aliases:
           - ${DOMAIN}  # –î–æ–º–µ–Ω–Ω–æ–µ –∏–º—è –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –≤–Ω—É—Ç—Ä–∏ —Å–µ—Ç–∏ 
    restart: unless-stopped
    
  haspd:  # –ú—ç–Ω–µ–¥–∂–µ—Ä –ª–∏—Ü–µ–Ω–∑–∏–π HASP
    build:
      context: ./haspd
      args:
        - LOG_DIR=/var/log/haspd/
        - BIN=${BIN}
    container_name: haspd
    hostname: ${DOMAIN}
    ports:
      - "5902:5901" #VNC
    volumes:
      - ./haspd/logs/:/var/log/haspd/
      - hasplm-data:/var/hasplm
      - ./haspd/config/hasplm.ini:/etc/hasplm/hasplm.ini
    networks:
      public:  
    restart: unless-stopped
    
  nginx:
    build:
      context: ./nginx 
    container_name: nginx
    ports:
      - "1540:1540"
      - "1541:1541"
      - "1545:1545"
      - "1555:1555"
      - "80:80" # Apache –≤–Ω—É—Ç—Ä–∏ server —Ç–µ–ø–µ—Ä—å –æ—Ç–¥–∞—ë—Ç Web-–∫–ª–∏–µ–Ω—Ç
      - "${ONEC_PORT_RANGE_DOCKER}:${ONEC_PORT_RANGE_DOCKER}" # –†–∞–±–æ—á–∏–µ –ø—Ä–æ—Ü–µ—Å—Å—ã (session)    
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf
      - ./nginx/templates:/etc/nginx/templates    
      - ./nginx/stream.d/:/etc/nginx/stream.d/
      - ./nginx/conf.d/:/etc/nginx/stream.d/
    environment:
      - DOMAIN_NAME=${DOMAIN}
      - IP_VM_1C=${IP_VM_1C}         
    depends_on: 
      - server
    networks: 
      - public # –î–ª—è —Å–≤—è–∑–∏ —Å server 
    restart: unless-stopped
    
networks:
  internal_pgsql:
    internal: true  # –°–∫—Ä—ã—Ç–∞—è —Å–µ—Ç—å (1C <-> PostgreSQL) 
  public:
    driver: bridge  # –û–±—ã—á–Ω–∞—è —Å–µ—Ç—å –¥–ª—è nginx 
volumes:
  pg-data-1c: #postgres —Ö—Ä–∞–Ω–∏—Ç –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö 
  1c-data: #1—Å —Ö—Ä–∞–Ω–∏—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–ª–∞—Å—Ç–µ—Ä–∞—Ö 
  1c-user-home: #–û–±—â–∞—è –ø–∞–ø–∫–∞ –¥–ª—è –∫–µ—à–∞ –∏ –µ—â–µ —á–µ–≥–æ-—Ç–æ
  hasplm-data: # hasplm - –≠—Ç–æ —Å–ª—É–∂–±–∞ –æ—Ç Guardant / SafeNet, –∫–æ—Ç–æ—Ä–∞—è –Ω—É–∂–Ω–∞ –¥–ª—è —Ä–∞–±–æ—Ç—ã HASP. 1–° –∏—Å–ø–æ–ª—å–∑—É–µ—Ç HASP (–ª–∏—Ü–µ–Ω–∑–∏–æ–Ω–Ω—ã–π –º–µ–Ω–µ–¥–∂–µ—Ä) 
